# cloudbuild.yaml ─ simple CI/CD for Cloud Run
# Substitute the values in ALL-CAPS or pass them as substitutions.

# Recommended substitutions to set in the trigger:
# _SERVICE        = demo-api           # Cloud Run service name
# _IMAGE_REPO     = gcp-demo           # Artifact Registry repository
# _REGION         = us-west1           # Build + deploy region

steps:
# ───── 1. Build the container image ────────────────────────────────
- name: 'gcr.io/cloud-builders/docker'
  args:
    [
      'build',
      '-t',
      '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_IMAGE_REPO}/${_SERVICE}:${SHORT_SHA}',
      '.'
    ]

# ───── 2. Push the image to Artifact Registry ──────────────────────
images:
- '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_IMAGE_REPO}/${_SERVICE}:${SHORT_SHA}'

# ───── 3. Deploy to Cloud Run ──────────────────────────────────────
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args:
    [
      'run', 'deploy', '${_SERVICE}',
      '--project', '$PROJECT_ID',
      '--region',  '${_REGION}',
      '--image',   '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_IMAGE_REPO}/${_SERVICE}:${SHORT_SHA}',
      '--quiet',
      '--platform', 'managed',
      '--allow-unauthenticated'    # remove if you lock the service down
    ]

# Keep the most recent 10 build logs / artifacts.
options:
  logStreamingOption: STREAM_ON
  substitutionOption: ALLOW_LOOSE
  machineType: 'E2_SMALL'          # change if you need more CPU/RAM
timeout: '900s'                    # 15 minutes

